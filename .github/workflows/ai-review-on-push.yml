name: ai-review-on-push

on:
  push:
    branches: [ main, feat/** ]
    paths:
      - "backend/**"
      - "frontend/**"

permissions:
  contents: write
  actions: read

jobs:
  review:
    name: LLM code review on push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute diff (from previous SHA to current)
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"
          BRANCH="${{ github.ref_name }}"

          # 필요한 범위만 가볍게 페치
          git fetch --no-tags --prune --depth=2 origin "${BRANCH}" || true

          # 브랜치 최초 푸시인 경우(before=000... 이거나 비어있음) 대비
          if [[ -z "${BEFORE}" || "${BEFORE}" == "0000000000000000000000000000000000000000" ]]; then
            # 리포지토리의 최초 커밋(루트 커밋)과 비교
            BEFORE=$(git rev-list --max-parents=0 "${AFTER}" | tail -n1)
          fi

          # 범위 diff (여러 커밋이 한 번에 push 되어도 커버)
          git diff --unified=0 "${BEFORE}" "${AFTER}" > diff.patch || true

          # 너무 길면 자르기 (토큰 과다 방지)
          head -c 18000 diff.patch > diff.trunc.patch || true

          BYTES=$(wc -c < diff.trunc.patch | tr -d ' ')
          echo "bytes=${BYTES}" >> "$GITHUB_OUTPUT"

      - name: Skip if no diff
        if: steps.diff.outputs.bytes == '0'
        run: echo "No changes to review."

      - name: Build review prompt
        if: steps.diff.outputs.bytes != '0'
        shell: bash
        run: |
          set -euo pipefail
          cat > system.txt <<'SYS'
          You are a senior software reviewer.
          Return a terse, actionable review of the provided git diff.
          - Focus on correctness, security, concurrency, resource leaks, nullability, SQL/Redis usage, and performance.
          - Point to specific files/lines from the diff (as shown in the patch) and suggest concrete fixes.
          - Add a short ✅ Summary / ⚠️ Risks / 🛠 Fixes list.
          - If diff only contains scaffolding or trivial changes, say so briefly.
          SYS

          # 줄바꿈/따옴표 보존하여 JSON-safe 문자열 생성
          SYS_JSON=$(jq -Rs . < system.txt)
          DIFF_JSON=$(jq -Rs . < diff.trunc.patch)

          # 최종 payload를 jq -n으로 직접 구성
          jq -n --argjson sys "$SYS_JSON" --argjson dif "$DIFF_JSON" \
            '{"model":"gpt-4o-mini","input":[{"role":"system","content":$sys},{"role":"user","content":$dif}]}' \
            > payload.final.json

      - name: Call OpenAI Responses API
        if: steps.diff.outputs.bytes != '0'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${OPENAI_API_KEY:-}" ]; then
            echo "OPENAI_API_KEY secret is missing"; exit 1
          fi

          curl -sS https://api.openai.com/v1/responses \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @payload.final.json \
            | tee openai.json >/dev/null

          # output[0].content[0].text 추출 (없으면 실패 처리)
          jq -r '.output[0].content[0].text // empty' openai.json > review.md
          if [ ! -s review.md ]; then
            echo "No output_text in response:"; cat openai.json; exit 1
          fi

      - name: Post review comment to the commit
        if: steps.diff.outputs.bytes != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('review.md', 'utf8').slice(0, 65000);
            const { owner, repo } = context.repo;
            await github.rest.repos.createCommitComment({
              owner,
              repo,
              commit_sha: context.sha,
              body
            });

      - name: Upload review artifact (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-review
          path: |
            diff.patch
            diff.trunc.patch
            review.md
            openai.json
