name: ai-review-on-push

on:
  push:
    branches: [ main, feat/** ]
    paths:
      - "backend/**"
      - "frontend/**"

permissions:
  contents: write
  actions: read

jobs:
  review:
    name: LLM code review on push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute diff (from previous SHA to current)
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"
          BRANCH="${{ github.ref_name }}"

          # í•„ìš”í•œ ë²”ìœ„ë§Œ ê°€ë³ê²Œ íŽ˜ì¹˜
          git fetch --no-tags --prune --depth=2 origin "${BRANCH}" || true

          # ë¸Œëžœì¹˜ ìµœì´ˆ í‘¸ì‹œì¸ ê²½ìš°(before=000... ì´ê±°ë‚˜ ë¹„ì–´ìžˆìŒ) ëŒ€ë¹„
          if [[ -z "${BEFORE}" || "${BEFORE}" == "0000000000000000000000000000000000000000" ]]; then
            # ë¦¬í¬ì§€í† ë¦¬ì˜ ìµœì´ˆ ì»¤ë°‹(ë£¨íŠ¸ ì»¤ë°‹)ê³¼ ë¹„êµ
            BEFORE=$(git rev-list --max-parents=0 "${AFTER}" | tail -n1)
          fi

          # ë²”ìœ„ diff (ì—¬ëŸ¬ ì»¤ë°‹ì´ í•œ ë²ˆì— push ë˜ì–´ë„ ì»¤ë²„)
          git diff --unified=0 "${BEFORE}" "${AFTER}" > diff.patch || true

          # ë„ˆë¬´ ê¸¸ë©´ ìžë¥´ê¸° (í† í° ê³¼ë‹¤ ë°©ì§€)
          head -c 18000 diff.patch > diff.trunc.patch || true

          BYTES=$(wc -c < diff.trunc.patch | tr -d ' ')
          echo "bytes=${BYTES}" >> "$GITHUB_OUTPUT"

      - name: Skip if no diff
        if: steps.diff.outputs.bytes == '0'
        run: echo "No changes to review."

      - name: Build review prompt
        if: steps.diff.outputs.bytes != '0'
        shell: bash
        run: |
          set -euo pipefail
          cat > system.txt <<'SYS'
          You are a senior software reviewer.
          Return a terse, actionable review of the provided git diff.
          - Focus on correctness, security, concurrency, resource leaks, nullability, SQL/Redis usage, and performance.
          - Point to specific files/lines from the diff (as shown in the patch) and suggest concrete fixes.
          - Add a short âœ… Summary / âš ï¸ Risks / ðŸ›  Fixes list.
          - If diff only contains scaffolding or trivial changes, say so briefly.
          SYS

          # ì¤„ë°”ê¿ˆ/ë”°ì˜´í‘œ ë³´ì¡´í•˜ì—¬ JSON-safe ë¬¸ìžì—´ ìƒì„±
          SYS_JSON=$(jq -Rs . < system.txt)
          DIFF_JSON=$(jq -Rs . < diff.trunc.patch)

          # ìµœì¢… payloadë¥¼ jq -nìœ¼ë¡œ ì§ì ‘ êµ¬ì„±
          jq -n --argjson sys "$SYS_JSON" --argjson dif "$DIFF_JSON" \
            '{"model":"gpt-4o-mini","input":[{"role":"system","content":$sys},{"role":"user","content":$dif}]}' \
            > payload.final.json

      - name: Call OpenAI Responses API
        if: steps.diff.outputs.bytes != '0'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${OPENAI_API_KEY:-}" ]; then
            echo "OPENAI_API_KEY secret is missing"; exit 1
          fi

          curl -sS https://api.openai.com/v1/responses \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @payload.final.json \
            | tee openai.json >/dev/null

          # output[0].content[0].text ì¶”ì¶œ (ì—†ìœ¼ë©´ ì‹¤íŒ¨ ì²˜ë¦¬)
          jq -r '.output[0].content[0].text // empty' openai.json > review.md
          if [ ! -s review.md ]; then
            echo "No output_text in response:"; cat openai.json; exit 1
          fi

      - name: Post review comment to the commit
        if: steps.diff.outputs.bytes != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('review.md', 'utf8').slice(0, 65000);
            const { owner, repo } = context.repo;
            await github.rest.repos.createCommitComment({
              owner,
              repo,
              commit_sha: context.sha,
              body
            });

      - name: Upload review artifact (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-review
          path: |
            diff.patch
            diff.trunc.patch
            review.md
            openai.json
