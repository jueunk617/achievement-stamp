name: ai-review-on-push

on:
  push:
    branches: [ main, feat/** ]
    paths: [ "backend/**", "frontend/**" ]

permissions:
  contents: write  # ì»¤ë°‹ ì½”ë©˜íŠ¸ ìž‘ì„± ê¶Œí•œ
  actions: read

jobs:
  review:
    name: LLM code review on push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute diff (from previous SHA to current)
        id: diff
        shell: bash
        run: |
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"
          # ì•ˆì „í•˜ê²Œ í•„ìš”í•œ ë²”ìœ„ë§Œ íŽ˜ì¹˜
          git fetch --no-tags --prune --depth=2 origin "${{ github.ref_name }}" || true

          # ë²”ìœ„ diff (ì—¬ëŸ¬ ì»¤ë°‹ì´ í•œ ë²ˆì— push ë˜ì–´ë„ ì»¤ë²„)
          git diff --unified=0 "$BEFORE" "$AFTER" > diff.patch || true

          # ë„ˆë¬´ ê¸¸ë©´ ìžë¥´ê¸° (í† í° ê³¼ë‹¤ ë°©ì§€)
          head -c 18000 diff.patch > diff.trunc.patch
          echo "bytes=$(wc -c < diff.trunc.patch)" >> $GITHUB_OUTPUT

      - name: Skip if no diff
        if: steps.diff.outputs.bytes == '0'
        run: echo "No changes to review."

      - name: Build review prompt
        if: steps.diff.outputs.bytes != '0'
        shell: bash
        run: |
          cat > system.txt <<'SYS'
          You are a senior software reviewer.
          Return a terse, actionable review of the provided git diff.
          - Focus on correctness, security, concurrency, resource leaks, nullability, SQL/Redis usage, and performance.
          - Point to specific files/lines from the diff (as shown in the patch) and suggest concrete fixes.
          - Add a short âœ… Summary / âš ï¸ Risks / ðŸ›  Fixes list.
          - If diff only contains scaffolding or trivial changes, say so briefly.
          SYS

          # ë””í”„ ë‚´ìš©ì„ JSON-safe ë¬¸ìžì—´ë¡œ
          jq -Rs . < diff.trunc.patch > diff.json

          # Responses API payload ìƒì„± (OpenAI)
          cat > payload.json <<'JSON'
          {
            "model": "gpt-4o-mini",
            "input": [
              { "role": "system", "content": __SYSTEM__ },
              { "role": "user",   "content": __DIFF__ }
            ]
          }
          JSON

          SYSTEM_ESCAPED=$(jq -Rs . < system.txt)
          DIFF_ESCAPED=$(cat diff.json)

          # placeholder ì¹˜í™˜
          jq -n --argjson sys "$SYSTEM_ESCAPED" --argjson dif "$DIFF_ESCAPED" '
            (input | .input[0].content = $sys | .input[1].content = $dif)
          ' payload.json > payload.final.json

      - name: Call OpenAI Responses API
        if: steps.diff.outputs.bytes != '0'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        shell: bash
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "OPENAI_API_KEY secret is missing"; exit 1
          fi

          # Responses API í˜¸ì¶œ
          curl -sS https://api.openai.com/v1/responses \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @payload.final.json \
            | tee openai.json >/dev/null

          # ê²°ê³¼ í…ìŠ¤íŠ¸ ì¶”ì¶œ (output_textê°€ ì—†ìœ¼ë©´ ì‹¤íŒ¨ ì²˜ë¦¬)
          jq -r '.output_text // empty' openai.json > review.md
          if [ ! -s review.md ]; then
            echo "No output_text in response:"; cat openai.json; exit 1
          fi

      - name: Post review comment to the commit
        if: steps.diff.outputs.bytes != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('review.md', 'utf8').slice(0, 65000);
            const { owner, repo } = context.repo;
            await github.rest.repos.createCommitComment({
              owner,
              repo,
              commit_sha: context.sha,
              body
            });

      - name: Upload review artifact (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-review
          path: |
            diff.patch
            diff.trunc.patch
            review.md
            openai.json
